<div class="relative w-full h-full">

  <div class="w-full h-full z-0">
    <app-map [pins]="locations" goBelow (routeSummary)="onRouteSummary($event)"></app-map>
  </div>

  <div
    class="absolute bottom-15 left-10 w-80 bg-white rounded-xl shadow-lg p-4"
  >
    <div class="flex justify-between text-sm text-gray-500 mb-2">
      <span class="font-semibold text-black">Order</span>
      <span>
        Time:
        <b>{{ estimateMinutes ?? '—' }} minutes</b>
      </span>
    </div>

    <div class="space-y-3">
      <div>
        <label class="text-xs text-gray-500">Start:</label>
        <input
          class="w-full border rounded-lg px-3 py-2 text-sm"
          [value]="startLocation?.address"
          readonly
        />
      </div>
      <div>
        <label class="text-xs text-gray-500">Finish:</label>
        <input
          class="w-full border rounded-lg px-3 py-2 text-sm"
          [value]="endLocation?.address"
          readonly
        />
      </div>

      <div>
        <button
          type="button"
          class="mt-4 w-full bg-lime-400 hover:bg-lime-500 text-black font-semibold py-2 rounded-lg cursor-pointer active:scale-[0.98]"
          (click)="openStopConfirm()"
        >
          Stop ride
        </button>
      </div>
    </div>
  </div>


  <button
    class="absolute right-6 bottom-52 bg-white shadow-lg rounded-full w-11 h-11 flex items-center justify-center cursor-pointer active:scale-[0.98]"
    (click)="chatClick()"
  >
    <ng-icon name="bootstrapChatDots" size="26"></ng-icon>
  </button>


  <button
    type="button"
    class="absolute right-6 bottom-36 bg-white rounded-full w-11 h-11 flex items-center justify-center cursor-pointer active:scale-[0.98]"
    (click)="panicClick()"
  >
    <ng-icon name="bootstrapExclamationCircleFill" size="36" color="red"></ng-icon>
  </button>
</div>

@if (stopConfirmOpen) {
  <div
    class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center"
    (click)="closeStopConfirm()"
  >
    <div
      class="bg-white rounded-xl shadow-xl w-130 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold">Stop ride</h2>
        <button
          type="button"
          class="text-gray-500"
          (click)="closeStopConfirm()"
          [disabled]="stopSubmitting"
        >
          ✕
        </button>
      </div>

      <p class="text-sm text-gray-600 mb-4">
        Stop the ride now? Destination will be updated to this stop location and the price will be recalculated.
      </p>

      @if (stopError) {
        <div
          class="mb-3 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700"
        >
          {{ stopError }}
        </div>
      }

      <div class="flex gap-3 justify-end">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50"
          (click)="closeStopConfirm()"
          [disabled]="stopSubmitting"
        >
          Cancel
        </button>

        <button
          type="button"
          class="px-4 py-2 rounded-lg bg-lime-400 hover:bg-lime-500 font-semibold enabled:cursor-pointer"
          (click)="stopRideNow()"
          [disabled]="stopSubmitting"
        >
          @if (stopSubmitting) { Stopping... } @else { Stop }
        </button>
      </div>
    </div>
  </div>
}

@if (toastVisible) {
  <div
    class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg"
  >
    {{ toastMessage }}
  </div>
}

@if (stopSummaryOpen && stopResult) {

  <div
    class="fixed top-6 left-1/2 -translate-x-1/2 bg-lime-300 text-black px-10 py-2 rounded-full shadow font-semibold z-[60]"
  >
    You have arrived!
  </div>

  <div
    class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center"
    (click)="goBackAfterStop()"
  >
    <div
      class="bg-white rounded-xl shadow-xl w-[520px] p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Ride finished</h2>
        <button
          type="button"
          class="text-gray-500 hover:text-black"
          (click)="goBackAfterStop()"
        >
          ✕
        </button>
      </div>

      <!-- Time / Price -->
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="text-xs text-gray-500 mb-1">Time</div>
          <div
            class="inline-flex items-center justify-center px-4 py-1 rounded-full bg-gray-100 text-sm font-semibold"
          >
            {{ estimateMinutes ?? '—' }} min
          </div>
        </div>

        <div class="text-right">
          <div class="text-xs text-gray-500 mb-1">Price</div>
          <div
            class="inline-flex items-center justify-center px-4 py-1 rounded-full bg-lime-200 text-sm font-semibold"
          >
            {{ stopResult.price | number:'1.2-2' }} RSD
          </div>
        </div>
      </div>

      <!-- Addresses / time -->
      <div class="space-y-2 text-sm text-gray-700 mb-4">
        <p><b>From:</b> {{ startLocation?.address }}</p>
        <p><b>To:</b> {{ stopResult.newDestination.address }}</p>
        <p>
          <b>Finished at:</b>
          {{ stopResult.endedAt | date:'short' }}
        </p>
      </div>

      <div class="flex justify-end">
        <button
          type="button"
          class="px-4 py-2 rounded-lg bg-lime-400 hover:bg-lime-500 font-semibold"
          (click)="goBackAfterStop()"
        >
          Back to driver screen
        </button>
      </div>
    </div>
  </div>

}

